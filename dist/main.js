(()=>{"use strict";var e={642:function(e,t,i){var n,r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(910));i(142).config();const a=null!==(n=Number(process.env.POOT))&&void 0!==n?n:5e3,l=(e,t={})=>r(void 0,void 0,void 0,(function*(){var i;const n=new Date,r=null!==(i=l.staticVariable)&&void 0!==i?i:l.staticVariable={apiCallHist:new Array(4).fill(0)},o=Math.max(r.apiCallHist[0]+1e3-n.getTime(),0);r.apiCallHist.shift(),r.apiCallHist.push(n.getTime()+o),o&&(yield new Promise((e=>setTimeout(e,o)))),console.log("APIを呼び出しました");const{response:d,body:c}=yield new Promise((i=>(0,s.default)({url:"https://cafe.kiite.jp"+e,qs:t,json:!0,port:a},((e,t,n)=>{i(Object.assign({},{error:e,response:t,body:n}))}))));if(200===(null==d?void 0:d.statusCode))return c;throw console.error(d),new Error(`[${d.statusCode}]${d.statusMessage}`)}));t.default=l},727:function(e,t){var i,n,r,o=this&&this.__classPrivateFieldSet||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},s=this&&this.__classPrivateFieldGet||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){i.set(this,void 0),n.set(this,void 0),r.set(this,void 0),o(this,i,e,"f")}standby(e){o(this,n,e,"f"),o(this,r,setTimeout((()=>s(this,i,"f").deferReply(e)),2e3),"f")}reply(e){return s(this,i,"f").replied||s(this,i,"f").deferred?s(this,i,"f").editReply(e):(void 0!==s(this,r,"f")&&clearTimeout(s(this,r,"f")),s(this,i,"f").reply(Object.assign(Object.assign({},e),s(this,n,"f"))))}},i=new WeakMap,n=new WeakMap,r=new WeakMap},170:function(e,t,i){var n,r,o,s,a=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))},l=this&&this.__classPrivateFieldSet||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},d=this&&this.__classPrivateFieldGet||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)},c=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=e[i]&&function(t){return new Promise((function(n,r){!function(e,t,i,n){Promise.resolve(n).then((function(t){e({value:t,done:i})}),t)}(n,r,(t=e[i](t)).done,t.value)}))}}},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const f=u(i(642)),h=u(i(665));class p{constructor(e){s.set(this,void 0),l(this,s,e,"f")}static noticeSong(e,t){var i,o,s,l;return a(this,void 0,void 0,(function*(){const u=yield d(p,n,"f",r).get(t.video_id),f={},h=[];if(!u)return;for(const t of Object.keys(u)){const n=new p(t),{channelId:r,dm:a}=yield n.getData();if(a){const n=null!==(i=e.users.cache.get(t))&&void 0!==i?i:yield e.users.fetch(t);if(void 0===n)throw Error("DMの取得に失敗しました");h.push(n)}else if(void 0===r)n.unregisterNoticeList(),console.log("deleate",t);else{const i=null!==(o=e.channels.cache.get(r))&&void 0!==o?o:e.channels.fetch(r);if(void 0===i)throw Error("チャンネルの取得に失敗しました");i.guild.members.fetch(t).catch((e=>{n.unregisterNoticeList(),console.log("delete",t)})),null!==(s=f[l=i.id])&&void 0!==s||(f[l]={channel:i,userIds:[]}),f[i.id].userIds.push(t)}}const v=[],y="リストの曲が流れるよ！";for(const e of h){const t=e.send(y);v.push(t)}for(const e of Object.keys(f)){const t=f[e].channel.send(f[e].userIds.map((e=>`<@${e}>`)).join("")+y);v.push(t)}return setTimeout((()=>a(this,void 0,void 0,(function*(){var e,i;try{for(var n,r=c(v);!(n=yield r.next()).done;){const e=n.value;e.edit(e.content.replace(y,`__${t.title}__が流れたよ！`))}}catch(t){e={error:t}}finally{try{n&&!n.done&&(i=r.return)&&(yield i.call(r))}finally{if(e)throw e.error}}}))),new Date(t.start_time).getTime()+Number(t.msec_duration)-Date.now()),Promise.all(v)}))}registerNoticeList(e,t,i){return a(this,void 0,void 0,(function*(){const{userId:a}=yield this.getData();a&&(yield this.unregisterNoticeList());for(const t of e.songs)d(p,n,"f",r).get(t.video_id).then(((e={})=>{e[d(this,s,"f")]=d(this,s,"f"),d(p,n,"f",r).set(t.video_id,e)}));return d(p,n,"f",o).set(d(this,s,"f"),{userId:d(this,s,"f"),channelId:t,dm:i,registeredList:e}),!0}))}updateNoticeList(e,t){return a(this,void 0,void 0,(function*(){const{registeredList:i,channelId:n}=yield this.getData();if(void 0===i)throw Error("リストが登録されていません！`/ib register`コマンドを使ってリストを登録しましょう！");const r=yield(0,f.default)("/api/playlists/contents/detail",{list_id:i.list_id});if("failed"===r.status)throw Error(`プレイリストの取得に失敗しました！登録されていたリスト（${i.list_title}）は存在していますか？\n存在している場合、Kiiteが混み合っている可能性があるので時間を置いてもう一度試してみてください。`);if(n===e&&r.updated_at===i.updated_at)throw Error("プレイリストは最新の状態です！");return this.registerNoticeList(r,e,t),r}))}unregisterNoticeList(){return a(this,void 0,void 0,(function*(){const{registeredList:e}=yield this.getData();if(void 0===e)throw Error("リストが登録されていません！");d(p,n,"f",o).delete(d(this,s,"f"));for(const t of e.songs)d(p,n,"f",r).get(t.video_id).then(((e={})=>{delete e[d(this,s,"f")],Object.keys(e).length?d(p,n,"f",r).set(t.video_id,e):d(p,n,"f",r).delete(t.video_id)}));return e}))}getData(){return a(this,void 0,void 0,(function*(){return yield d(p,n,"f",o).get(d(this,s,"f")).then((e=>null!=e?e:{}))}))}}t.default=p,n=p,s=new WeakMap,r={value:new h.default("sqlite://db.sqlite",{table:"noticeList"})},o={value:new h.default("sqlite://db.sqlite",{table:"userData"})}},519:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t},s=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const l=o(i(349)),d=a(i(642)),c=a(i(170)),u=a(i(727)),f=a(i(142)),h=new l.Client({intents:["GUILDS"]});f.default.config(),h.once("ready",(()=>{var e,t;g();const i=[{name:"ib",description:"KiiteCafeでの選曲を通知します",options:[{name:"now",description:"Cafeで今流れている曲やCafeにいる人数などを表示します",type:"SUB_COMMAND"},{name:"register",description:"通知する曲のリストとしてKiiteのプレイリストを登録します",type:"SUB_COMMAND",options:[{type:"STRING",name:"url",description:"追加するプレイリストのURL",required:!0}]},{name:"list",description:"登録されているリストの情報を表示します",type:"SUB_COMMAND"},{name:"update",description:"登録されているリストの情報を再登録し、Kiiteのプレイリストの更新を反映させます",type:"SUB_COMMAND"},{name:"unregister",description:"リストの登録を解除し、選曲通知を停止します",type:"SUB_COMMAND",options:[{type:"USER",name:"target",description:"登録を解除させたいユーザー（ユーザー指定にはチャンネルの管理権限が必要です）",required:!1}]}]}];void 0===process.env.TEST_SERVER_ID?null===(e=h.application)||void 0===e||e.commands.set(i):null===(t=h.application)||void 0===t||t.commands.set(i,process.env.TEST_SERVER_ID)})),h.on("interactionCreate",(e=>s(void 0,void 0,void 0,(function*(){if(!e.isCommand()||"ib"!==e.commandName)return;const t=new u.default(e);try{const i={now:v,register:y,list:m,update:w,unregister:_}[e.options.getSubcommand()];if(void 0===i)return;yield i(t,e)}catch(e){e instanceof Error?t.reply({embeds:[{title:e.name,description:e.message,color:"#ff0000"}]}).catch((e=>console.error(e))):console.error(e)}}))));const p=e=>[{title:`${e.list_title}`,url:`https://kiite.jp/playlist/${e.list_id}`,description:`**全${e.songs.length}曲**\n${e.description}`,footer:{text:`最終更新: ${e.updated_at}`}}],v=(e,t)=>s(void 0,void 0,void 0,(function*(){var t,i,n;const r=e=>`${e/6e4|0}:${((e/1e3|0)%60).toString().padStart(2,"0")}`;e.standby({ephemeral:!0});const o=(0,d.default)("/api/cafe/user_count"),s=yield(0,d.default)("/api/cafe/now_playing"),a=yield(0,d.default)("/api/cafe/rotate_users",{ids:s.id.toString()}),l=yield(0,d.default)("/api/artist/id",{artist_id:s.artist_id});yield e.reply({embeds:[{title:s.title,url:"https://www.nicovideo.jp/watch/"+s.baseinfo.video_id,author:{name:s.baseinfo.user_nickname,icon_url:s.baseinfo.user_icon_url,url:null!==(t="https://kiite.jp/creator/"+(null==l?void 0:l.creator_id))&&void 0!==t?t:""},thumbnail:{url:s.thumbnail},color:s.colors[0],fields:[{name:((e,t,i)=>{const n=11*e/t|0;return new Array(12).fill("").map(((e,t)=>0===t?n>0?"┣":"┠":11===t?11<=n?"┫":"┤":t===n?"╉":t<n?"━":"─")).join("")})(Date.now()-Date.parse(s.start_time),s.msec_duration),value:`${r(Date.now()-Date.parse(s.start_time))} / ${r(s.msec_duration)}`,inline:!1},{name:":arrow_forward:再生数",value:Number(s.baseinfo.view_counter).toLocaleString("ja"),inline:!0},{name:":busts_in_silhouette:Cafe内の人数",value:(yield o).toLocaleString("ja"),inline:!0},{name:":arrows_counterclockwise:回転数",value:(null!==(n=null===(i=a[s.id])||void 0===i?void 0:i.length)&&void 0!==n?n:0).toLocaleString("ja"),inline:!0}]}]})})),y=(e,t)=>s(void 0,void 0,void 0,(function*(){var i;e.standby({ephemeral:!0});const n=t.options.getString("url"),[r]=null!==(i=n.match(/(?<=https:\/\/kiite.jp\/playlist\/)\w+/))&&void 0!==i?i:[];if(!r)throw Error("URLが正しくありません！`https://kiite.jp/playlist/`で始まるURLを入力してください！");const o=yield(0,d.default)("/api/playlists/contents/detail",{list_id:r});if("failed"===o.status)throw Error("プレイリストの取得に失敗しました！URLが間違っていませんか？\nURLが正しい場合、Kiiteが混み合っている可能性があるので時間を置いてもう一度試してみてください。");const s=new c.default(t.user.id);yield s.registerNoticeList(o,t.channelId,!t.inGuild()),yield e.reply({content:"以下のリストを通知リストとして登録しました！",embeds:p(o)})})),m=(e,t)=>s(void 0,void 0,void 0,(function*(){e.standby({ephemeral:!0});const i=new c.default(t.user.id),{registeredList:n}=yield i.getData();if(void 0===n)throw Error("リストが登録されていません！`/ib register`コマンドを使ってリストを登録しましょう！");yield e.reply({content:"以下のリストが通知リストとして登録されています！",embeds:p(n)})})),w=(e,t)=>s(void 0,void 0,void 0,(function*(){e.standby({ephemeral:!0});const i=new c.default(t.user.id),n=yield i.updateNoticeList(t.channelId,!t.inGuild());yield e.reply({content:"以下のリストから通知リストを更新しました！",embeds:p(n)})})),_=(e,t)=>s(void 0,void 0,void 0,(function*(){var i,n;const r=null!==(i=t.options.getUser("target"))&&void 0!==i?i:t.user,o=r.id===t.user.id,s=new c.default(r.id),{channelId:a}=yield s.getData();if(!o&&t.channelId!==a)throw Error("指定ユーザーのリスト登録解除は通知先として設定されているチャンネル内で行う必要があります！");if(!o&&!(null===(n=t.memberPermissions)||void 0===n?void 0:n.has("MANAGE_CHANNELS")))throw e.standby({ephemeral:!0}),Error("指定ユーザーのリスト登録解除にはチャンネルの管理権限が必要です！");e.standby({ephemeral:o}),yield s.unregisterNoticeList(),yield e.reply({content:o?"リストの登録を解除しました！":`<@${r.id}>のリストの登録を解除しました！`})})),g=()=>s(void 0,void 0,void 0,(function*(){let e=!1;for(;;)try{const t=e?"/api/cafe/next_song":"/api/cafe/now_playing",i=yield(0,d.default)(t),n=(new Date).getTime(),r=new Date(i.start_time).getTime(),o=r+Math.min(i.msec_duration,48e4);e&&c.default.noticeSong(h,i),setTimeout((()=>{var e;return null===(e=h.user)||void 0===e?void 0:e.setActivity({name:i.title,type:"LISTENING"})}),Math.max(r-n,0)),yield new Promise((t=>setTimeout(t,Math.max(o-6e4-n,e?3e3:0)))),e=(new Date).getTime()<o}catch(e){console.error(e),yield new Promise((e=>setTimeout(e,15e3)))}}));if(void 0===process.env.TOKEN)throw Error("トークンが設定されていません！");h.login(process.env.TOKEN)},349:e=>{e.exports=require("discord.js")},142:e=>{e.exports=require("dotenv")},665:e=>{e.exports=require("keyv")},910:e=>{e.exports=require("request")}},t={};!function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,i),o.exports}(519)})();